import{a as h,o as k,G as E,s as P,d as T,b as I,g as L,c as f,e as w}from"./assets/config-CXb8XrOZ.js";async function b(e,r){console.log("Analyzing page with Gemini Vision API...");const o=r.geminiApiKey?.trim();if(!o)throw new Error("Gemini APIキーが設定されていません。");const n=r.skills.map(t=>`- ${t.name}: ${t.years}年 (Lv.${t.level}${t.isProfessional?", 実務あり":""})`).join(`
`),c=e.split(",")[1],m={contents:[{parts:[{text:`
あなたはフリーランスエンジニアの強力なエージェント「Lito」です。提供されたスクリーンショットの案件詳細を解析してください。

ユーザープロフィール：
- 希望単価：月${r.targetRate.toLocaleString()}円
- 職種：${r.category}
- スキル：
${n}

上記プロフィールに合わせたアドバイスを3つ、具体的かつ簡潔に回答してください。
回答形式：3つの箇条書き（改行区切り）
`},{inlineData:{mimeType:"image/png",data:c}}]}]};async function l(t){const s=`https://generativelanguage.googleapis.com/v1beta/models/${t}:generateContent?key=${o}`;return fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)})}async function a(){const t=`https://generativelanguage.googleapis.com/v1beta/models?key=${o}`;try{const i=await(await fetch(t)).json();return console.log("Available models for this key:",i.models?.map(u=>u.name)),i.models||[]}catch(s){return console.error("Failed to list models:",s),[]}}try{const t=["gemini-2.0-flash","gemini-flash-latest","gemini-1.5-flash","gemini-1.5-pro"];let s=null;for(const i of t){console.log(`Attempting analysis with ${i}...`);const u=await l(i);if(u.ok){const y=((await u.json()).candidates?.[0]?.content?.parts?.[0]?.text||"").split(`
`).map(p=>p.replace(/^[*-]\s*/,"").trim()).filter(p=>p.length>0).slice(0,3);return{timestamp:new Date().toISOString(),suggestions:y.length>0?y:["解析結果が得られませんでした。"]}}if(s=u,u.status!==404)break}if(s&&!s.ok){const i=await s.json().catch(()=>({}));throw console.error("Gemini API Final Error Detail:",i),s.status===404?(await a(),new Error("利用可能なGeminiモデルが見つかりません(404)。Google Cloud Consoleで『Generative Language API』を有効にしてから数分待つか、AI Studioで新しいプロジェクトを作成して新しいキーを取得してみてください。")):new Error(`APIエラー (${s.status}): ${i.error?.message||"不明なエラー"}`)}throw new Error("解析リクエストに失敗しました。")}catch(t){throw console.error("Analysis execution failed:",t),t}}async function v(e,r){const o=e.geminiApiKey?.trim();if(!o)throw new Error("APIキーが設定されていません。");const g={contents:[{parts:[{text:`
あなたはユーザーの代理人エンジニアです。以下の案件解析結果とスキルに基づき、クライアントに送る「応募文（提案文）」を作成してください。
文体は丁寧ですが、プロフェッショナルな自信を感じさせるものにしてください。

ユーザーのスキル：${e.skills.map(a=>`- ${a.name}: ${a.years}年`).join(", ")}
案件解析のポイント：${r.suggestions.join(" / ")}

構成：
1. 挨拶
2. 案件への関心と適合する理由
3. 具体的な貢献内容
4. 結びの言葉

返信は「応募文の本文のみ」を出力してください。
`}]}]},m=["gemini-2.0-flash","gemini-flash-latest","gemini-1.5-flash"];let l=null;for(const a of m)try{console.log(`Attempting proposal generation with ${a}...`);const t=await A(a,o,g);if(t.ok)return(await t.json()).candidates?.[0]?.content?.parts?.[0]?.text||"応募文を生成できませんでした。";const s=await t.json().catch(()=>({}));if(l=new Error(`APIエラー (${t.status}): ${s.error?.message||"不明なエラー"}`),t.status!==404)break}catch(t){l=t}throw l||new Error("応募文の生成に失敗しました。")}async function R(e,r,o){const n=e.geminiApiKey?.trim();if(!n)throw new Error("APIキーが設定されていません。");const c=o.history?.slice(-5).map(t=>({role:t.role==="user"?"user":"model",parts:[{text:t.text}]}))||[],m={contents:[{role:"user",parts:[{text:`
あなたはフリーランスエンジニアのエージェント「Lito」です。
ユーザーは案件ページを見ながら、あなたに「独り言」のように不安や質問を投げかけています。
前回の解析結果（${o.analysisResults?.suggestions.join("、")}）を踏まえ、
ユーザーを励ましつつ、エンジニアとしての客観的な視点でアドバイスを返してください。
回答は親しみやすく、かつ短く（150文字以内）まとめてください。
`}]},{role:"model",parts:[{text:"了解しました。エージェントLitoとして、解析結果に基づきアドバイスします。"}]},...c,{role:"user",parts:[{text:r}]}]},l=["gemini-2.0-flash","gemini-flash-latest","gemini-1.5-flash"];let a=null;for(const t of l)try{console.log(`Attempting chat with ${t}...`);const s=await A(t,n,m);if(s.ok)return(await s.json()).candidates?.[0]?.content?.parts?.[0]?.text||"お答えできませんでした。";const i=await s.json().catch(()=>({}));if(a=new Error(`APIエラー (${s.status}): ${i.error?.message||"不明なエラー"}`),s.status!==404)break}catch(s){a=s}throw a||new Error("チャット回答の取得に失敗しました。")}async function A(e,r,o){const n=`https://generativelanguage.googleapis.com/v1beta/models/${e}:generateContent?key=${r}`;return fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})}async function $(){try{const e="351204538325-ptgb6kpq97ki2n43jl5gfmfresdefd9n.apps.googleusercontent.com",r=chrome.identity.getRedirectURL(),o=["openid","email","profile"].join(" "),n=`https://accounts.google.com/o/oauth2/v2/auth?client_id=${e}&response_type=token&redirect_uri=${encodeURIComponent(r)}&scope=${encodeURIComponent(o)}`;console.log("Starting launchWebAuthFlow with Redirect URI:",r);const c=await new Promise((a,t)=>{chrome.identity.launchWebAuthFlow({url:n,interactive:!0},s=>{if(chrome.runtime.lastError)return console.error("launchWebAuthFlow error:",chrome.runtime.lastError.message),t(new Error(chrome.runtime.lastError.message));if(!s)return t(new Error("No redirect URL received"));const i=new URL(s.replace("#","?")),d=new URLSearchParams(i.search).get("access_token");if(!d)return console.error("Access token not found in redirect URL:",s),t(new Error("Access token not found"));a(d)})}),g=E.credential(null,c),l=(await P(h,g)).user;console.log("Logged in via Identity API:",l.uid),await S(l)}catch(e){console.error("Login failed:",e)}}async function S(e){const{uid:r,email:o,displayName:n}=e,c=T(I,"users",r);(await L(c)).exists()?await f(c,{email:o,displayName:n,lastLoginAt:w()},{merge:!0}):await f(c,{email:o,displayName:n,createdAt:w(),skills:[],preferences:{targetRate:0,category:""}}),console.log("User synced to Firestore:",r)}chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(console.error);chrome.action.onClicked.addListener(()=>{h.currentUser||$()});chrome.runtime.onMessage.addListener((e,r,o)=>{if(e.type==="START_ANALYSIS")return C(e.profile).then(o),!0;if(e.type==="LOGIN")return console.log("LOGIN message received from sidepanel"),$().then(()=>o({success:!0})).catch(n=>o({success:!1,error:n.message})),!0;if(e.type==="GENERATE_PROPOSAL")return x(e.profile,e.analysisResults).then(o),!0;if(e.type==="SOLILOQUY_CHAT")return U(e.profile,e.message,e.context).then(o),!0});async function C(e){try{console.log("Analysis request received with profile:",e);const[r]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!r||!r.id)throw new Error("No active tab found");const o=await chrome.tabs.captureVisibleTab();return console.log("Screenshot captured successfully"),{success:!0,results:await b(o,e)}}catch(r){return console.error("Analysis handler failed:",r),{success:!1,error:r.message}}}async function x(e,r){try{return{success:!0,proposal:await v(e,r)}}catch(o){return{success:!1,error:o.message}}}async function U(e,r,o){try{return{success:!0,reply:await R(e,r,o)}}catch(n){return{success:!1,error:n.message}}}k(h,e=>{e?console.log("User is logged in:",e.uid):console.log("User is logged out")});
