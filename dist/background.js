import{a as p,o as E,G as I,s as P,d as T,b,g as L,c as f,e as w}from"./assets/config-CXb8XrOZ.js";async function v(e,r){console.log("Analyzing page with Gemini Vision API...");const t=r.geminiApiKey?.trim();if(!t)throw new Error("Gemini APIキーが設定されていません。");const n=r.skills.map(o=>`- ${o.name}: ${o.years}年 (Lv.${o.level}${o.isProfessional?", 実務あり":""})`).join(`
`),c=e.split(",")[1],g={contents:[{parts:[{text:`
あなたはフリーランスエンジニアの強力なエージェント「Lito」です。提供されたスクリーンショットの案件詳細を解析してください。

ユーザープロフィール：
- 希望単価：月${r.targetRate.toLocaleString()}円
- 職種：${r.category}
- スキル：
${n}

上記プロフィールに合わせたアドバイスを3つ、具体的かつ簡潔に回答してください。
回答形式：3つの箇条書き（改行区切り）
`},{inlineData:{mimeType:"image/png",data:c}}]}]};async function u(o){const s=`https://generativelanguage.googleapis.com/v1beta/models/${o}:generateContent?key=${t}`;return fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)})}async function i(){const o=`https://generativelanguage.googleapis.com/v1beta/models?key=${t}`;try{const a=await(await fetch(o)).json();return console.log("Available models for this key:",a.models?.map(l=>l.name)),a.models||[]}catch(s){return console.error("Failed to list models:",s),[]}}try{const o=["gemini-2.0-flash","gemini-flash-latest","gemini-1.5-flash","gemini-1.5-pro"];let s=null;for(const a of o){console.log(`Attempting analysis with ${a}...`);const l=await u(a);if(l.ok){const y=((await l.json()).candidates?.[0]?.content?.parts?.[0]?.text||"").split(`
`).map(h=>h.replace(/^[*-]\s*/,"").trim()).filter(h=>h.length>0).slice(0,3);return{timestamp:new Date().toISOString(),suggestions:y.length>0?y:["解析結果が得られませんでした。"]}}if(s=l,l.status!==404)break}if(s&&!s.ok){const a=await s.json().catch(()=>({}));throw console.error("Gemini API Final Error Detail:",a),s.status===404?(await i(),new Error("利用可能なGeminiモデルが見つかりません(404)。Google Cloud Consoleで『Generative Language API』を有効にしてから数分待つか、AI Studioで新しいプロジェクトを作成して新しいキーを取得してみてください。")):new Error(`APIエラー (${s.status}): ${a.error?.message||"不明なエラー"}`)}throw new Error("解析リクエストに失敗しました。")}catch(o){throw console.error("Analysis execution failed:",o),o}}async function S(e,r){const t=e.geminiApiKey?.trim();if(!t)throw new Error("APIキーが設定されていません。");const m={contents:[{parts:[{text:`
あなたはユーザーの代理人エンジニアです。以下の案件解析結果とスキルに基づき、クライアントに送る「応募文（提案文）」を作成してください。
文体は丁寧ですが、プロフェッショナルな自信を感じさせるものにしてください。

ユーザーのスキル：${e.skills.map(i=>`- ${i.name}: ${i.years}年`).join(", ")}
案件解析のポイント：${r.suggestions.join(" / ")}

構成：
1. 挨拶
2. 案件への関心と適合する理由
3. 具体的な貢献内容
4. 結びの言葉

返信は「応募文の本文のみ」を出力してください。
`}]}]},g=["gemini-2.0-flash","gemini-flash-latest","gemini-1.5-flash"];let u=null;for(const i of g)try{console.log(`Attempting proposal generation with ${i}...`);const o=await A(i,t,m);if(o.ok)return(await o.json()).candidates?.[0]?.content?.parts?.[0]?.text||"応募文を生成できませんでした。";const s=await o.json().catch(()=>({}));if(u=new Error(`APIエラー (${o.status}): ${s.error?.message||"不明なエラー"}`),o.status!==404)break}catch(o){u=o}throw u||new Error("応募文の生成に失敗しました。")}async function R(e,r,t){const n=e.geminiApiKey?.trim();if(!n)throw new Error("APIキーが設定されていません。");const c=t.history?.slice(-5).map(o=>({role:o.role==="user"?"user":"model",parts:[{text:o.text}]}))||[],g={contents:[{role:"user",parts:[{text:`
あなたはフリーランスエンジニアのエージェント「Lito」です。
ユーザーは案件ページを見ながら、あなたに「独り言」のように不安や質問を投げかけています。
前回の解析結果（${t.analysisResults?.suggestions.join("、")}）を踏まえ、
ユーザーを励ましつつ、エンジニアとしての客観的な視点でアドバイスを返してください。
回答は親しみやすく、かつ短く（150文字以内）まとめてください。
`}]},{role:"model",parts:[{text:"了解しました。エージェントLitoとして、解析結果に基づきアドバイスします。"}]},...c,{role:"user",parts:[{text:r}]}]},u=["gemini-2.0-flash","gemini-flash-latest","gemini-1.5-flash"];let i=null;for(const o of u)try{console.log(`Attempting chat with ${o}...`);const s=await A(o,n,g);if(s.ok)return(await s.json()).candidates?.[0]?.content?.parts?.[0]?.text||"お答えできませんでした。";const a=await s.json().catch(()=>({}));if(i=new Error(`APIエラー (${s.status}): ${a.error?.message||"不明なエラー"}`),s.status!==404)break}catch(s){i=s}throw i||new Error("チャット回答の取得に失敗しました。")}async function A(e,r,t){const n=`https://generativelanguage.googleapis.com/v1beta/models/${e}:generateContent?key=${r}`;return fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}async function $(){try{const e="351204538325-ptgb6kpq97ki2n43jl5gfmfresdefd9n.apps.googleusercontent.com",r=chrome.identity.getRedirectURL(),t=["openid","email","profile"].join(" "),n=Math.random().toString(36).substring(2),c=`https://accounts.google.com/o/oauth2/v2/auth?client_id=${e}&response_type=id_token&redirect_uri=${encodeURIComponent(r)}&scope=${encodeURIComponent(t)}&nonce=${n}`;console.log("Starting launchWebAuthFlow (id_token) with Redirect URI:",r);const m=await new Promise((o,s)=>{chrome.identity.launchWebAuthFlow({url:c,interactive:!0},a=>{if(chrome.runtime.lastError)return console.error("launchWebAuthFlow error:",chrome.runtime.lastError.message),s(new Error(chrome.runtime.lastError.message));if(!a)return s(new Error("No redirect URL received"));const l=new URL(a.replace("#","?")),d=new URLSearchParams(l.search).get("id_token");if(!d)return console.error("ID token not found in redirect URL:",a),s(new Error("ID token not found"));o(d)})}),g=I.credential(m),i=(await P(p,g)).user;console.log("Logged in via Identity API:",i.uid),await C(i)}catch(e){console.error("Login failed:",e)}}async function C(e){const{uid:r,email:t,displayName:n}=e,c=T(b,"users",r);(await L(c)).exists()?await f(c,{email:t,displayName:n,lastLoginAt:w()},{merge:!0}):await f(c,{email:t,displayName:n,createdAt:w(),skills:[],preferences:{targetRate:0,category:""}}),console.log("User synced to Firestore:",r)}chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(console.error);chrome.action.onClicked.addListener(()=>{p.currentUser||$()});chrome.runtime.onMessage.addListener((e,r,t)=>{if(e.type==="START_ANALYSIS")return x(e.profile).then(t),!0;if(e.type==="LOGIN")return console.log("LOGIN message received from sidepanel"),$().then(()=>t({success:!0})).catch(n=>t({success:!1,error:n.message})),!0;if(e.type==="GENERATE_PROPOSAL")return U(e.profile,e.analysisResults).then(t),!0;if(e.type==="SOLILOQUY_CHAT")return j(e.profile,e.message,e.context).then(t),!0});async function x(e){try{console.log("Analysis request received with profile:",e);const[r]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!r||!r.id)throw new Error("No active tab found");const t=await chrome.tabs.captureVisibleTab();return console.log("Screenshot captured successfully"),{success:!0,results:await v(t,e)}}catch(r){return console.error("Analysis handler failed:",r),{success:!1,error:r.message}}}async function U(e,r){try{return{success:!0,proposal:await S(e,r)}}catch(t){return{success:!1,error:t.message}}}async function j(e,r,t){try{return{success:!0,reply:await R(e,r,t)}}catch(n){return{success:!1,error:n.message}}}E(p,e=>{e?console.log("User is logged in:",e.uid):console.log("User is logged out")});
