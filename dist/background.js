import{a as m,o as w,G as A,s as v,d as b,b as k,g as I,c as p,e as y}from"./assets/config-CXb8XrOZ.js";async function P(e,t){console.log("Analyzing page with Gemini Vision API...");const o=t.geminiApiKey?.trim();if(!o)throw new Error("Gemini APIキーが設定されていません。");const s=e.split(",")[1],l={contents:[{parts:[{text:`あなたはフリーランスエンジニアの強力なエージェント「Lito」です。提供されたスクリーンショットの案件詳細を解析し、ユーザーのプロフィール（目標：${t.targetRate}、職種：${t.category}、スキル：${t.skills.join(", ")}）に合わせたアドバイスを3つ簡潔に回答してください。`},{inlineData:{mimeType:"image/png",data:s}}]}]};async function u(n){const r=`https://generativelanguage.googleapis.com/v1beta/models/${n}:generateContent?key=${o}`;return fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)})}async function g(){const n=`https://generativelanguage.googleapis.com/v1beta/models?key=${o}`;try{const a=await(await fetch(n)).json();return console.log("Available models for this key:",a.models?.map(c=>c.name)),a.models||[]}catch(r){return console.error("Failed to list models:",r),[]}}try{const n=["gemini-2.0-flash","gemini-flash-latest","gemini-1.5-flash","gemini-1.5-pro"];let r=null;for(const a of n){console.log(`Attempting analysis with ${a}...`);const c=await u(a);if(c.ok){const h=((await c.json()).candidates?.[0]?.content?.parts?.[0]?.text||"").split(`
`).map(d=>d.replace(/^[*-]\s*/,"").trim()).filter(d=>d.length>0).slice(0,3);return{timestamp:new Date().toISOString(),suggestions:h.length>0?h:["解析結果が得られませんでした。"]}}if(r=c,c.status!==404)break}if(r&&!r.ok){const a=await r.json().catch(()=>({}));throw console.error("Gemini API Final Error Detail:",a),r.status===404?(await g(),new Error("利用可能なGeminiモデルが見つかりません(404)。Google Cloud Consoleで『Generative Language API』を有効にしてから数分待つか、AI Studioで新しいプロジェクトを作成して新しいキーを取得してみてください。")):new Error(`APIエラー (${r.status}): ${a.error?.message||"不明なエラー"}`)}throw new Error("解析リクエストに失敗しました。")}catch(n){throw console.error("Analysis execution failed:",n),n}}async function f(){try{const e=await new Promise((i,l)=>{chrome.identity.getAuthToken({interactive:!0},u=>{if(chrome.runtime.lastError)return l(new Error(chrome.runtime.lastError.message));const g=typeof u=="string"?u:u?.token;if(!g)return l(new Error("Failed to get auth token"));i(g)})}),t=A.credential(null,e),s=(await v(m,t)).user;console.log("Logged in via Identity API:",s.uid),await S(s)}catch(e){console.error("Login failed:",e)}}async function S(e){const{uid:t,email:o,displayName:s}=e,i=b(k,"users",t);(await I(i)).exists()?await p(i,{email:o,displayName:s,lastLoginAt:y()},{merge:!0}):await p(i,{email:o,displayName:s,createdAt:y(),skills:[],preferences:{targetRate:0,category:""}}),console.log("User synced to Firestore:",t)}chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(console.error);chrome.action.onClicked.addListener(()=>{m.currentUser||f()});chrome.runtime.onMessage.addListener((e,t,o)=>{if(e.type==="START_ANALYSIS")return T(e.profile).then(o),!0;if(e.type==="LOGIN")return console.log("LOGIN message received from sidepanel"),f().then(()=>o({success:!0})).catch(s=>o({success:!1,error:s.message})),!0});async function T(e){try{console.log("Analysis request received with profile:",e);const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t||!t.id)throw new Error("No active tab found");const o=await chrome.tabs.captureVisibleTab();return console.log("Screenshot captured successfully"),{success:!0,results:await P(o,e)}}catch(t){return console.error("Analysis handler failed:",t),{success:!1,error:t.message}}}w(m,e=>{e?console.log("User is logged in:",e.uid):console.log("User is logged out")});
